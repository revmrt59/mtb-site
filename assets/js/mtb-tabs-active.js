/* =========================================================
   MTB: Active tab highlighting for tabs generated by book.js
   Works even if tabs are injected after page load.
========================================================= */

(function () {
  function getDocParam() {
    const params = new URLSearchParams(window.location.search);
    return params.get("doc") || "";
  }

  function getDocFromHref(href) {
    try {
      const url = new URL(href, window.location.href);
      return url.searchParams.get("doc") || "";
    } catch (e) {
      return "";
    }
  }

  function applyActiveTab() {
    const tabsRoot = document.getElementById("tabs");
    if (!tabsRoot) return;

    const currentDoc = getDocParam();
    const items = tabsRoot.querySelectorAll("a, button");
    if (!items.length) return;

    items.forEach(el => el.classList.remove("is-active"));

    // Match by ?doc= value in href
    let matched = false;
    items.forEach(el => {
      const href = el.getAttribute("href") || "";
      const doc = getDocFromHref(href);
      if (doc && currentDoc && doc === currentDoc) {
        el.classList.add("is-active");
        matched = true;
      }
    });

    // If no match (some builds may not use ?doc=), fall back to exact URL compare
    if (!matched) {
      const currentUrl = window.location.href;
      items.forEach(el => {
        const href = el.getAttribute("href") || "";
        if (href && currentUrl.includes(href)) {
          el.classList.add("is-active");
        }
      });
    }
  }

  function watchForTabInjection() {
    const tabsRoot = document.getElementById("tabs");
    if (!tabsRoot) return;

    // Apply immediately
    applyActiveTab();

    // Re-apply whenever book.js injects/rebuilds the tabs
    const obs = new MutationObserver(function () {
      applyActiveTab();
    });

    obs.observe(tabsRoot, { childList: true, subtree: true });

    // Also update active tab instantly when clicking a tab
    tabsRoot.addEventListener("click", function (e) {
      const el = e.target.closest("a, button");
      if (!el) return;

      const items = tabsRoot.querySelectorAll("a, button");
      items.forEach(x => x.classList.remove("is-active"));
      el.classList.add("is-active");
    });
  }

  document.addEventListener("DOMContentLoaded", watchForTabInjection);
})();
